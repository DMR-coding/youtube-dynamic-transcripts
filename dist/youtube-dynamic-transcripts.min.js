/******/ (function() { // webpackBootstrap
/******/ 	"use strict";
/******/ 	var __webpack_modules__ = ({

/***/ "./src/Caption.ts":
/*!************************!*\
  !*** ./src/Caption.ts ***!
  \************************/
/***/ (function(__unused_webpack_module, __webpack_exports__, __webpack_require__) {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   "Caption": function() { return /* binding */ Caption; }
/* harmony export */ });
function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

var Caption = function Caption(start, end, text) {
  _classCallCheck(this, Caption);

  _defineProperty(this, "domElement", void 0);

  _defineProperty(this, "start", void 0);

  _defineProperty(this, "end", void 0);

  this.end = end;
  this.start = start;
  this.domElement = document.createElement('a');
  this.domElement.textContent = text;
  this.domElement.className = 'caption';
};

/***/ }),

/***/ "./src/Transcript.ts":
/*!***************************!*\
  !*** ./src/Transcript.ts ***!
  \***************************/
/***/ (function(__unused_webpack_module, __webpack_exports__, __webpack_require__) {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   "Transcript": function() { return /* binding */ Transcript; }
/* harmony export */ });
/* harmony import */ var _utility__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./utility */ "./src/utility.ts");
/* harmony import */ var _Caption__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./Caption */ "./src/Caption.ts");
function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

/// <reference types="@types/youtube" />

/* global YT */


var LOADING = 'Loading transcript...';
var FAILED_LOAD = '⚠️ Could not load transcript.';
var OPEN_ME = 'Open Transcript';
var CLOSE_ME = 'Close Transcript';
var TRANSCRIPT_URL = 'https://video.google.com/timedtext?v=';
var Transcript = function Transcript(videoID, lang, transcriptName) {
  var _this = this;

  _classCallCheck(this, Transcript);

  _defineProperty(this, "player", void 0);

  _defineProperty(this, "captionTimeout", void 0);

  _defineProperty(this, "currentCaption", void 0);

  _defineProperty(this, "captions", []);

  _defineProperty(this, "videoID", void 0);

  _defineProperty(this, "captionBox", void 0);

  _defineProperty(this, "toggler", void 0);

  _defineProperty(this, "container", void 0);

  _defineProperty(this, "loadCaptions", function (captionsURL) {
    (0,_utility__WEBPACK_IMPORTED_MODULE_0__.get)(captionsURL).then(_this.captionsLoaded).catch(_this.captionsFailed);
    _this.captionBox.textContent = LOADING;
  });

  _defineProperty(this, "captionsLoaded", function (captions) {
    var xmlCaptions = captions.getElementsByTagName('text');
    _this.captionBox.textContent = '';

    var _loop = function _loop(i) {
      var start = +xmlCaptions[i].getAttribute('start');
      var end = +xmlCaptions[i].getAttribute('dur') + start;
      var caption = new _Caption__WEBPACK_IMPORTED_MODULE_1__.Caption(start, end, xmlCaptions[i].textContent);
      caption.domElement.addEventListener('click', function () {
        _this.seekToIndex(i);
      });

      _this.captions.push(caption);

      _this.captionBox.append(caption.domElement);

      _this.captionBox.scrollTo(0, 0);
    };

    for (var i = 0; i < xmlCaptions.length; i += 1) {
      _loop(i);
    }
  });

  _defineProperty(this, "seekToIndex", function (i) {
    var caption = _this.captions[i];

    _this.player.seekTo(caption.start, true);
  });

  _defineProperty(this, "captionsFailed", function () {
    _this.captionBox.textContent = FAILED_LOAD;
  });

  _defineProperty(this, "onStateChange", function (event) {
    console.log(event);

    if (event.data === YT.PlayerState.PLAYING) {
      _this.started();
    } else {
      _this.stopped();
    }
  });

  _defineProperty(this, "started", function () {
    _this.highlightCurrentCaption();
  });

  _defineProperty(this, "stopped", function () {
    _this.removeCurrentHighlight();

    _this.clearTimeout();
  });

  _defineProperty(this, "highlightCurrentCaption", function () {
    _this.removeCurrentHighlight();

    var currentTime = _this.player.getCurrentTime();

    _this.currentCaption = _this.captions.find(function (caption) {
      return caption.start <= currentTime && caption.end > currentTime;
    });

    if (_this.currentCaption) {
      (0,_utility__WEBPACK_IMPORTED_MODULE_0__.toggleClass)(_this.currentCaption.domElement, 'highlight', true);

      if (!(0,_utility__WEBPACK_IMPORTED_MODULE_0__.isWithinParentViewport)(_this.currentCaption.domElement)) {
        // Defer this so that it'll take effect after the page gets updated with the highlight class
        setTimeout(function () {
          _this.currentCaption.domElement.scrollIntoView();
        }, 0);
      }
    }

    _this.waitForNextCaption();
  });

  _defineProperty(this, "waitForNextCaption", function () {
    _this.clearTimeout();

    var currentTime = _this.player.getCurrentTime();

    var nextCaption = _this.captions.find(function (caption) {
      return caption.start > currentTime;
    });

    if (nextCaption) {
      var secondsUntil = nextCaption.start - currentTime;
      _this.captionTimeout = setTimeout(_this.highlightCurrentCaption, secondsUntil * 1000);
    }
  });

  _defineProperty(this, "clearTimeout", function () {
    if (_this.captionTimeout) {
      clearTimeout(_this.captionTimeout);
    }

    _this.captionTimeout = null;
  });

  _defineProperty(this, "appendContainer", function () {
    _this.container = document.createElement('div');
    _this.container.className = 'ytdt';
    _this.toggler = document.createElement('button');
    _this.toggler.className = 'toggle closed';

    _this.toggler.addEventListener('click', _this.toggle);

    _this.toggler.textContent = OPEN_ME;

    _this.container.append(_this.toggler);

    _this.captionBox = document.createElement('div');
    _this.captionBox.className = 'captions closed';

    _this.container.append(_this.captionBox);

    document.getElementById(_this.videoID).after(_this.container);
  });

  _defineProperty(this, "toggle", function () {
    (0,_utility__WEBPACK_IMPORTED_MODULE_0__.toggleClass)(_this.toggler, 'closed');
    (0,_utility__WEBPACK_IMPORTED_MODULE_0__.toggleClass)(_this.toggler, 'open');
    (0,_utility__WEBPACK_IMPORTED_MODULE_0__.toggleClass)(_this.captionBox, 'closed');
    (0,_utility__WEBPACK_IMPORTED_MODULE_0__.toggleClass)(_this.captionBox, 'open');

    if (_this.toggler.className.indexOf('closed') > -1) {
      _this.toggler.textContent = OPEN_ME;
    } else {
      _this.toggler.textContent = CLOSE_ME;
    }
  });

  _defineProperty(this, "removeCurrentHighlight", function () {
    if (_this.currentCaption) {
      (0,_utility__WEBPACK_IMPORTED_MODULE_0__.toggleClass)(_this.currentCaption.domElement, 'highlight', false);
      _this.currentCaption = null;
    }
  });

  this.videoID = videoID;
  var url = TRANSCRIPT_URL + videoID;

  if (lang) {
    url += "&lang=".concat(lang);
  }

  if (transcriptName) {
    url += "&name=".concat(transcriptName);
  }

  this.appendContainer();
  this.loadCaptions(url);
  this.player = new YT.Player(videoID, {
    videoId: videoID,
    events: {
      onStateChange: this.onStateChange
    }
  });
};

/***/ }),

/***/ "./src/utility.ts":
/*!************************!*\
  !*** ./src/utility.ts ***!
  \************************/
/***/ (function(__unused_webpack_module, __webpack_exports__, __webpack_require__) {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   "toggleClass": function() { return /* binding */ toggleClass; },
/* harmony export */   "stringFilter": function() { return /* binding */ stringFilter; },
/* harmony export */   "get": function() { return /* binding */ get; },
/* harmony export */   "isWithinParentViewport": function() { return /* binding */ isWithinParentViewport; }
/* harmony export */ });
function toggleClass(node, className, force) {
  var exists = node.className.indexOf(className) >= 0;
  var shouldExist = force == null ? !exists : force;

  if (exists && shouldExist || !exists && !shouldExist) {
    return;
  }

  if (shouldExist) {
    node.className += " ".concat(className);
  } else {
    node.className = stringFilter(node.className, className, ' ');
  }
}
function stringFilter(classNames, className, separator) {
  return classNames.split(separator).filter(function (c) {
    return c !== className;
  }).join(separator);
}
function get(url) {
  return new Promise(function (resolve, reject) {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', url);
    xhr.responseType = 'document';

    xhr.onload = function () {
      resolve(xhr.response);
    };

    xhr.onerror = function () {
      reject(xhr.status);
    };

    xhr.send();
  });
}
function isWithinParentViewport(element) {
  var rect = element.getBoundingClientRect();
  var parentRect = element.parentElement.getBoundingClientRect();
  return rect.top >= parentRect.top && rect.bottom <= parentRect.bottom;
}

/***/ })

/******/ 	});
/************************************************************************/
/******/ 	// The module cache
/******/ 	var __webpack_module_cache__ = {};
/******/ 	
/******/ 	// The require function
/******/ 	function __webpack_require__(moduleId) {
/******/ 		// Check if module is in cache
/******/ 		var cachedModule = __webpack_module_cache__[moduleId];
/******/ 		if (cachedModule !== undefined) {
/******/ 			return cachedModule.exports;
/******/ 		}
/******/ 		// Create a new module (and put it into the cache)
/******/ 		var module = __webpack_module_cache__[moduleId] = {
/******/ 			// no module.id needed
/******/ 			// no module.loaded needed
/******/ 			exports: {}
/******/ 		};
/******/ 	
/******/ 		// Execute the module function
/******/ 		__webpack_modules__[moduleId](module, module.exports, __webpack_require__);
/******/ 	
/******/ 		// Return the exports of the module
/******/ 		return module.exports;
/******/ 	}
/******/ 	
/************************************************************************/
/******/ 	/* webpack/runtime/define property getters */
/******/ 	!function() {
/******/ 		// define getter functions for harmony exports
/******/ 		__webpack_require__.d = function(exports, definition) {
/******/ 			for(var key in definition) {
/******/ 				if(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {
/******/ 					Object.defineProperty(exports, key, { enumerable: true, get: definition[key] });
/******/ 				}
/******/ 			}
/******/ 		};
/******/ 	}();
/******/ 	
/******/ 	/* webpack/runtime/global */
/******/ 	!function() {
/******/ 		__webpack_require__.g = (function() {
/******/ 			if (typeof globalThis === 'object') return globalThis;
/******/ 			try {
/******/ 				return this || new Function('return this')();
/******/ 			} catch (e) {
/******/ 				if (typeof window === 'object') return window;
/******/ 			}
/******/ 		})();
/******/ 	}();
/******/ 	
/******/ 	/* webpack/runtime/hasOwnProperty shorthand */
/******/ 	!function() {
/******/ 		__webpack_require__.o = function(obj, prop) { return Object.prototype.hasOwnProperty.call(obj, prop); }
/******/ 	}();
/******/ 	
/******/ 	/* webpack/runtime/make namespace object */
/******/ 	!function() {
/******/ 		// define __esModule on exports
/******/ 		__webpack_require__.r = function(exports) {
/******/ 			if(typeof Symbol !== 'undefined' && Symbol.toStringTag) {
/******/ 				Object.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });
/******/ 			}
/******/ 			Object.defineProperty(exports, '__esModule', { value: true });
/******/ 		};
/******/ 	}();
/******/ 	
/******/ 	/* webpack/runtime/publicPath */
/******/ 	!function() {
/******/ 		var scriptUrl;
/******/ 		if (__webpack_require__.g.importScripts) scriptUrl = __webpack_require__.g.location + "";
/******/ 		var document = __webpack_require__.g.document;
/******/ 		if (!scriptUrl && document) {
/******/ 			if (document.currentScript)
/******/ 				scriptUrl = document.currentScript.src
/******/ 			if (!scriptUrl) {
/******/ 				var scripts = document.getElementsByTagName("script");
/******/ 				if(scripts.length) scriptUrl = scripts[scripts.length - 1].src
/******/ 			}
/******/ 		}
/******/ 		// When supporting browsers where an automatic publicPath is not supported you must specify an output.publicPath manually via configuration
/******/ 		// or pass an empty string ("") and set the __webpack_public_path__ variable from your code to use your own logic.
/******/ 		if (!scriptUrl) throw new Error("Automatic publicPath is not supported in this browser");
/******/ 		scriptUrl = scriptUrl.replace(/#.*$/, "").replace(/\?.*$/, "").replace(/\/[^\/]+$/, "/");
/******/ 		__webpack_require__.p = scriptUrl;
/******/ 	}();
/******/ 	
/************************************************************************/
var __webpack_exports__ = {};
// This entry need to be wrapped in an IIFE because it need to be isolated against other entry modules.
!function() {
var __webpack_exports__ = {};
/*!**********************!*\
  !*** ./src/index.ts ***!
  \**********************/
__webpack_require__.r(__webpack_exports__);
/* harmony import */ var _Transcript__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./Transcript */ "./src/Transcript.ts");
function _createForOfIteratorHelper(o, allowArrayLike) { var it; if (typeof Symbol === "undefined" || o[Symbol.iterator] == null) { if (Array.isArray(o) || (it = _unsupportedIterableToArray(o)) || allowArrayLike && o && typeof o.length === "number") { if (it) o = it; var i = 0; var F = function F() {}; return { s: F, n: function n() { if (i >= o.length) return { done: true }; return { done: false, value: o[i++] }; }, e: function e(_e) { throw _e; }, f: F }; } throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method."); } var normalCompletion = true, didErr = false, err; return { s: function s() { it = o[Symbol.iterator](); }, n: function n() { var step = it.next(); normalCompletion = step.done; return step; }, e: function e(_e2) { didErr = true; err = _e2; }, f: function f() { try { if (!normalCompletion && it.return != null) it.return(); } finally { if (didErr) throw err; } } }; }

function _unsupportedIterableToArray(o, minLen) { if (!o) return; if (typeof o === "string") return _arrayLikeToArray(o, minLen); var n = Object.prototype.toString.call(o).slice(8, -1); if (n === "Object" && o.constructor) n = o.constructor.name; if (n === "Map" || n === "Set") return Array.from(o); if (n === "Arguments" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen); }

function _arrayLikeToArray(arr, len) { if (len == null || len > arr.length) len = arr.length; for (var i = 0, arr2 = new Array(len); i < len; i++) { arr2[i] = arr[i]; } return arr2; }


var pendingInits = [];
var transcripts = [];
var ytdt = {
  Transcript: _Transcript__WEBPACK_IMPORTED_MODULE_0__.Transcript,
  init: function init(videoId, lang, name) {
    if (window.YT) {
      transcripts.push(new _Transcript__WEBPACK_IMPORTED_MODULE_0__.Transcript(videoId, lang, name));
    } else {
      pendingInits.push([videoId, lang, name]);
    }
  }
};
var oldOnYouTubeIframeAPIReady = window.onYouTubeIframeAPIReady;

window.onYouTubeIframeAPIReady = function () {
  if (oldOnYouTubeIframeAPIReady) {
    oldOnYouTubeIframeAPIReady();
  }

  var _iterator = _createForOfIteratorHelper(pendingInits),
      _step;

  try {
    for (_iterator.s(); !(_step = _iterator.n()).done;) {
      var pending = _step.value;
      ytdt.init.apply(this, pending);
    }
  } catch (err) {
    _iterator.e(err);
  } finally {
    _iterator.f();
  }
};

if (window.ytdt) {
  console.warn('Namespace already exists; not registering youtube-dynamic-transcripts');
} else {
  window.ytdt = ytdt;
}
}();
// This entry need to be wrapped in an IIFE because it need to be isolated against other entry modules.
!function() {
/*!************************!*\
  !*** ./src/index.scss ***!
  \************************/
__webpack_require__.r(__webpack_exports__);
/* harmony default export */ __webpack_exports__["default"] = (__webpack_require__.p + "youtube-dynamic-transcripts.min.css");
}();
/******/ })()
;
//# sourceMappingURL=youtube-dynamic-transcripts.min.js.map